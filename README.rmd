---
title: "Calculating MIRACLE Score from Bulk Gene Expression Datasets"
author: "Tolga Turan"
date: "June 14, 2019"
output: github_document
---

##INTRODUCTION:
**MIRACLE** is short for "**M**ediators of **I**mmune **R**esponse **A**gainst **C**ancer in so**L**id micro**E**nvironments".
The genesets are generated using a straigthforward approach as explained in the associated publication. Briefly, the cohorts where immune infiltrate has good prognosis association as well as the ones with opposite prognosis association are used as training sets.
The markers generated by the training samples are used to calculate single-sample GeneSet Enrichment (ssGSE) scores and mathematical ratio of ssGSE scores of good prognosis cohorts to worse prognosis cohorts gives Miracle Score.


##INSTALLATION:
First install the latest version of the dependency package "yaGST":

``` {r install_yaGST, echo=TRUE, eval=FALSE}
library(devtools)
install_github("miccec/yaGST")
```
Then install Miracle as follows:
``` {r install_MIRACLE, echo=TRUE, eval=FALSE}
library(devtools)
install_github("tolgaturan-github/Miracle")
```

##USAGE:
To calculate Miracle score, use a gene expression matrix normalized by methods including but not limited to EDASeq for RNA-seq or Quantile or RMA for Microarrays.
 
Please note that Miracle has not been tested on Nanostring platforms or RNAseq RPKM or FPKM normalizations.

The accepted feature_identifiers are "ens" for Ensemble Gene Ids; "u133p2" for Affymetrix U133p2 or U133A probe_ids; "entrez" for Entrez Gene Ids; "gene" for Gene Symbols and "ilmn" for IlluminaHT12v3 or IlluminaHT12v4 microarray platforms. 

###Example1: Calculating Miracle Scores and Measuring Survival Association in TCGA-BLCA:
_Please note that this vignette makes use of "ggplot2" and "survival" packages which are not necessary for installation but necessary to replicate this vignette._

Load normalized gene expression and Survival Data for TCGA-BLCA
``` {r load_data, echo=TRUE, eval=TRUE}
library(survival)
library(ggplot2)
library(Miracle)
data("SURV_BLCA","TCGA_BLCA_EDASeq_norm",package="Miracle") 
head(SURV_BLCA)
TCGA_BLCA_EDASeq_norm[1:5, 1:5]
```

Calculate ICR and Miracle Scores and merge with survival data:

``` {r calculate_miracle, results="hide", message=FALSE}
TCGA_ICR_and_miracle_scores<-Calculate_Miracle(TCGA_BLCA_EDASeq_norm, "ens")
```

``` {r merge_data, echo=TRUE, eval=TRUE}
head(TCGA_ICR_and_miracle_scores)
all(rownames(TCGA_ICR_and_miracle_scores)==SURV_BLCA[,1])
TCGA_BLCA_Miracle_SURV<-cbind(SURV_BLCA, TCGA_ICR_and_miracle_scores)
head(TCGA_BLCA_Miracle_SURV)
```
 Calculate Survival association of ICR in TCGA_BLCA Cohort:

``` {r survival_association_ICR, echo=TRUE, eval=TRUE}
coxph(Surv(Time, Status)~ICR, data=TCGA_BLCA_Miracle_SURV)
```
Calculate Survival association of Miracle in TCGA_BLCA Cohort:

``` {r survival_association_Miracle, echo=TRUE, eval=TRUE}
coxph(Surv(Time, Status)~Miracle, data=TCGA_BLCA_Miracle_SURV)
```
###Example2: Calculating Miracle Scores and Measuring Immunotherapy Response Association in GSE91061 (Riaz et al.):

Load normalized gene expression and Survival Data for GSE91061
``` {r load_data_GSE91061, echo=TRUE, eval=TRUE}
data("GSE91061_PRETREATMENT_EDAseq_NORM","GSE91061_PRETREATMENT_Response",package="Miracle")
head(GSE91061_PRETREATMENT_Response)
GSE91061_PRETREATMENT_EDAseq_NORM[1:5, 1:5]
```
Calculate ICR and Miracle Scores and merge with response data:

``` {r calculate_miracle_GSE91061, results="hide"}
GSE91061_ICR_and_miracle_scores<-Calculate_Miracle(GSE91061_PRETREATMENT_EDAseq_NORM, "ens")
```

``` {r merge_data_GSE91061, echo=TRUE, eval=TRUE}
head(GSE91061_ICR_and_miracle_scores)
all(rownames(GSE91061_ICR_and_miracle_scores)==rownames(GSE91061_PRETREATMENT_Response))
GSE91061_Miracle_Response<-cbind(GSE91061_PRETREATMENT_Response, GSE91061_ICR_and_miracle_scores)
head(GSE91061_Miracle_Response)
```

Calculate Response association of Miracle in GSE91061:

``` {r response_association_Miracle, echo=TRUE, eval=TRUE}
t.test(Miracle~Response, data=GSE91061_Miracle_Response)

```

Visualize Miracle Association with Response in GSE91061:

``` {r Visualize_response_association_Miracle, echo=TRUE, eval=TRUE}
ggplot(GSE91061_Miracle_Response, aes(x=Response, y=Miracle, colour=Response))+geom_boxplot(outlier.shape=NA)+geom_jitter(shape=16, position=position_jitter(0.2))
```

_Similar to these examples, Miracle scores calculated by the 'Calculate\_Miracle' function on normalized RNAseq or Microarray datasets, can be associated with Survival or Response attributes._

 

